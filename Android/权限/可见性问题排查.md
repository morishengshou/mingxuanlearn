常见原因与排查思路如下（即使已声明 QUERY_ALL_PACKAGES，仍只能看到自身包名）：

1) 权限声明位置/合并问题
- 确认权限写在最终生效的 AndroidManifest.xml（主模块，而不是仅 library 模块）。library 的 uses-permission 不会自动赋给宿主应用。
- 多模块/多 flavor 时检查 manifest merge 结果（app/build/outputs/logs/manifest-merger-…）。确保最终 manifest 里真的包含:
  <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />
- 不是放在 <queries> 里。QUERY_ALL_PACKAGES 是 <uses-permission>，而非 <queries> 子项。

2) targetSdkVersion 与系统版本不匹配预期
- Android 11+ 上才有“可见性”限制。低于 30 的 target（或低系统）行为不同，但不会导致“只有自己”。你现在“只有自己”，通常是运行在 Android 11+ 且 targetSdk ≥ 30。
- API 33+ 使用新签名调用：pm.getInstalledPackages(PackageInfoFlags.of(0))。旧重载虽可用但已弃用；不过这不会单独导致只返回自身，但建议切换新 API，避免 flag 行为异常。

3) 设备/ROM 或应用商店合规策略的过滤
- Google Play 政策：即便你在 manifest 声明了 QUERY_ALL_PACKAGES，系统仍会授予权限，但 Play 审核不通过会影响上架，而不会影响本地调试。
- 少数国产 ROM 或企业设备可能对应用可见性做了额外限制（尤其工作配置/个人资料隔离、MDM 管控）。在此类环境下可能仍被过滤。可在原生 Pixel/模拟器（Android 11/12/13）对比验证。

4) 运行环境是工作资料(Profile)或受限制用户
- 在“工作资料”或多用户环境下，只能看到同一用户/资料空间内可见的应用。若你的应用在工作资料里，通常看不到个人资料的应用。
- 通过 adb shell pm list packages 在对应 user 下验证：adb shell pm list packages --user 10（示例 userId）。

5) 代码调用方式或 flag 使用不当
- 确认未传入不合适的 flag 组合导致过滤。示例：
  val pm = context.packageManager
  val list = pm.getInstalledPackages(PackageManager.PackageInfoFlags.of(0))
  // 或
  val listApps = pm.getInstalledApplications(PackageManager.ApplicationInfoFlags.of(0))
- 不要用 MATCH_UNINSTALLED_PACKAGES 等过时 flag；在新 API 用 PackageInfoFlags/ApplicationInfoFlags。
- 在 Android 13+ 上用新的 API 重载；Kotlin 及 Java 都可以。

6) 进程/权限未刷新（冷启动或重装后测试）
- 改 manifest 后请重新完全安装（卸载再安装），而不是热替换。QUERY_ALL_PACKAGES 是安装时权限，不是运行时授予。
- 清缓存/数据后再次运行，确保没有你的自行缓存逻辑导致只显示一项。

7) 实际运行包名空间隔离（Instant App、Split、AppCloning）
- Instant Apps 无法使用此能力；确认不是 Instant/Feature-only 环境。
- 某些手机的“应用分身/双开”会把可见性限制在克隆空间。

8) 你在使用库方法间接查询且被过滤
- 某些三方库在 Android 11+ 内部改为基于 intent 的查询或白名单过滤，导致只返回有限结果。请直接用 PackageManager 验证原始结果。

快速自检清单
- 最终 manifest（合并后）里存在：<uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />
- 设备为标准 AOSP/官方模拟器，非工作资料/MDM 环境
- targetSdk ≥ 30，代码使用新 API：
  val pkgs = packageManager.getInstalledPackages(PackageManager.PackageInfoFlags.of(0))
  Log.d("size", pkgs.size.toString())
- 完全卸载后重装再测

如果以上都确认无误仍只看到自身包名，建议：
- 在同一设备用 adb 核对系统视角：adb shell pm list packages 看看系统列出的包是否远超 1 个。如果 adb 看到很多，而你的代码只有 1 个，说明应用可见性仍被限制（多半是工作资料/ROM 策略）。
- 提供你的 manifest 相关片段（uses-sdk、uses-permission、queries）和设备/系统信息（品牌、Android 版本、是否工作资料），我可以进一步帮你定位。