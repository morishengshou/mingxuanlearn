看起来你遇到的是 Android 11（API 30）及以上的「软件包可见性」限制导致的现象：默认情况下，应用只能“看到”自己以及少数系统允许暴露的包名。用 PackageManager.getInstalledPackages() 在新系统上如果没有声明可见性，就只能拿到本应用或几乎空列表。

可能原因与解决方案如下：

1) 目标 SDK 和系统版本限制
- 从 Android 11 起，如果你的 targetSdkVersion ≥ 30，且未声明可见性，getInstalledPackages()/getInstalledApplications()/queryIntentActivities() 等会过滤结果，只返回你可见的包（通常是自己）。
- 在 Android 13（API 33）起，getInstalledPackages 已被标记为 deprecated，建议改用 PackageManager.getInstalledPackages(PackageManager.PackageInfoFlags.of(...))，但可见性规则仍然生效。

2) 声明软件包可见性（manifest）
在 AndroidManifest.xml 中使用 <queries> 显式声明你需要“看到”的包或匹配规则：

- 精确包名
  <queries>
      <package android:name="com.example.targetapp" />
      <package android:name="com.tencent.mm" />
  </queries>

- 基于 Intent 的匹配（更灵活）
  <queries>
      <intent>
          <action android:name="android.intent.action.VIEW" />
          <data android:scheme="http" />
      </intent>
      <intent>
          <action android:name="android.intent.action.MAIN" />
          <category android:name="android.intent.category.LAUNCHER" />
      </intent>
  </queries>

- 如果业务确实需要扫描大量已安装应用，可以使用查询所有包的权限（仅限 Play 政策允许的用例）
  <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />
注意：QUERY_ALL_PACKAGES 在 Google Play 有严格合规要求，滥用会被拒。能用 <queries> 精确声明就不要用这个权限。

3) 代码层面的调用方式
- 新 API 写法：
  val pm = context.packageManager
  val packages = pm.getInstalledPackages(PackageManager.PackageInfoFlags.of(0))
  // 或 pm.getInstalledApplications(ApplicationInfoFlags.of(0))

- 旧 API（已过时，但仍可在低版本编译/运行）
  val packages = pm.getInstalledPackages(0)

无论哪种写法，都受可见性限制影响，关键在 manifest 的 <queries> 或 QUERY_ALL_PACKAGES。

4) 常见踩坑
- 仅在 debug 构建可见而 release 不可见：检查不同 flavor/variant 的 manifest 合并结果是否包含 <queries>。
- 只声明了 Intent 查询，但你用的是 getInstalledPackages 遍历所有包名：如果没有 QUERY_ALL_PACKAGES，仍然拿不到完整列表。要么切到基于 Intent 的查询（queryIntentActivities），要么声明你需要可见的包（或合规使用 QUERY_ALL_PACKAGES）。
- 在 Android 10 及以下设备一切正常：因为当时还没有可见性限制。

5) 最小示例（仅获取所有可启动应用的列表）
- Manifest:
  <queries>
      <intent>
          <action android:name="android.intent.action.MAIN" />
          <category android:name="android.intent.category.LAUNCHER" />
      </intent>
  </queries>

- 代码:
  val pm = context.packageManager
  val intent = Intent(Intent.ACTION_MAIN).addCategory(Intent.CATEGORY_LAUNCHER)
  val resolveInfos = pm.queryIntentActivities(intent, PackageManager.ResolveInfoFlags.of(0))
  val packageNames = resolveInfos.map { it.activityInfo.packageName }.distinct()

如果你需要“完整已安装包列表”，请评估业务是否符合 Play 的 QUERY_ALL_PACKAGES 使用政策；若符合，在 manifest 中添加该权限并在隐私合规文档中说明用途；若不符合，改为基于 <queries> 精确声明或基于 Intent 的查询。